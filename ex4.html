
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>Exercice 4 : Ouverture d’un raster et enrichissement d’une couche vecteur &#8212; Documentation PythonQGIS_TP 2022.03</title>
    <link rel="stylesheet" href="_static/guzzle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/css/custom.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script type="text/javascript" src="_static/js/custom.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="next" title="Exercice 5 : Manipulation de couches vecteurs et géotraitements" href="ex5.html" />
    <link rel="prev" title="Exercice 3 : Géométries et calcul de champ" href="ex3.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Index général"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ex5.html" title="Exercice 5 : Manipulation de couches vecteurs et géotraitements"
             accesskey="N">suivant</a> |</li>
        <li class="right" >
          <a href="ex3.html" title="Exercice 3 : Géométries et calcul de champ"
             accesskey="P">précédent</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation PythonQGIS_TP 2022.03</a> &#187;</li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Contenu</h2>
    <div class="sidebar-localtoc">
      <ul>
<li><a class="reference internal" href="#">Exercice 4 : Ouverture d’un raster et enrichissement d’une couche vecteur</a><ul>
<li><a class="reference internal" href="#objectif">Objectif</a></li>
<li><a class="reference internal" href="#donnees">Données</a></li>
<li><a class="reference internal" href="#procedure">Procédure</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
</div>
  <h4>Sujet précédent</h4>
  <p class="topless"><a href="ex3.html"
                        title="Chapitre précédent">Exercice 3 : Géométries et calcul de champ</a></p>
  <h4>Sujet suivant</h4>
  <p class="topless"><a href="ex5.html"
                        title="Chapitre suivant">Exercice 5 : Manipulation de couches vecteurs et géotraitements</a></p>
  <div role="note" aria-label="source link">
    <h3>Cette page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/ex4.rst.txt"
            rel="nofollow">Montrer le code source</a></li>
    </ul>
   </div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="index.html">Docs</a></li>
              
              <li>Exercice 4 : Ouverture d’un raster et enrichissement d’une couche vecteur</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <div class="section" id="exercice-4-ouverture-d-un-raster-et-enrichissement-d-une-couche-vecteur">
<h1>Exercice 4 : Ouverture d’un raster et enrichissement d’une couche vecteur<a class="headerlink" href="#exercice-4-ouverture-d-un-raster-et-enrichissement-d-une-couche-vecteur" title="Lien permanent vers ce titre">¶</a></h1>
<div class="figure align-center" style="width: 98%">
<a class="reference internal image-reference" href="_images/ex5_mnt_color.png"><img alt="_images/ex5_mnt_color.png" src="_images/ex5_mnt_color.png" style="width: 40%;" /></a>
</div>
<div class="section" id="objectif">
<h2>Objectif<a class="headerlink" href="#objectif" title="Lien permanent vers ce titre">¶</a></h2>
<p>L’objectif de cet exercice est de <strong>créer le profil longitudinal d’un cours d’eau</strong>.</p>
<p>Cette opération nécessite de disposer de points à distance régulière le long du cours d’eau.
Une valeur d’altitude va ensuite être récupérée à partir d’un modèle numérique de terrain.</p>
<p>La dernière partie de l’exercice aborde la <strong>création d’une nouvelle couche temporaire en mémoire</strong>.</p>
<div class="figure align-center" style="width: 98%">
<a class="reference internal image-reference" href="_images/ex5_matplotlib.png"><img alt="_images/ex5_matplotlib.png" src="_images/ex5_matplotlib.png" style="width: 40%;" /></a>
</div>
</div>
<div class="section" id="donnees">
<h2>Données<a class="headerlink" href="#donnees" title="Lien permanent vers ce titre">¶</a></h2>
<div class="line-block">
<div class="line">• Tracé du Canal du Furon <code class="docutils literal notranslate"><span class="pre">Canal_Furon.shp</span></code> (Ligne - Source : IGN <a class="footnote-reference" href="#f1" id="id1">[1]</a>) ➜ <a class="reference external" href="https://mthh.github.io/TP_PythonQGIS/_static/CanalFuron.zip">Téléchargement</a></div>
<div class="line">• Modèle Numérique de terrain <code class="docutils literal notranslate"><span class="pre">DEM_N245E395_l93.tif</span></code> (Raster float 32bits - Source : EAA <a class="footnote-reference" href="#f2" id="id2">[2]</a>) ➜ <a class="reference external" href="https://mthh.github.io/TP_PythonQGIS/_static/Mnt.zip">Téléchargement</a></div>
</div>
<p>Les deux jeux de données utilisent la projection Lambert-93 (EPSG:2154).</p>
</div>
<div class="section" id="procedure">
<h2>Procédure<a class="headerlink" href="#procedure" title="Lien permanent vers ce titre">¶</a></h2>
<ul>
<li><p class="first">Ouvrir QGIS.</p>
</li>
<li><p class="first">Créer un nouveau projet.</p>
</li>
<li><p class="first">Décompresser les deux archives <code class="docutils literal notranslate"><span class="pre">zip</span></code> qui ont été téléchargées et ajouter les couches <code class="docutils literal notranslate"><span class="pre">Canal_Furon.shp</span></code> et <code class="docutils literal notranslate"><span class="pre">DEM_N245E395_l93.tif</span></code>.</p>
</li>
<li><p class="first">Ouvrir la console Python.</p>
</li>
<li><p class="first">Obtenir la référence de chacune de nos couches :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">line_lyr</span> <span class="o">=</span> <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s2">&quot;Canal_Furon&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dem</span> <span class="o">=</span> <span class="n">QgsProject</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">mapLayersByName</span><span class="p">(</span><span class="s2">&quot;DEM_N245E395_l93&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">Disposer des points à égale distance le long du tracé du cours d’eau :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Quelle est la longueur du cours d&#39;eau ?</span>
<span class="n">ft</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_lyr</span><span class="o">.</span><span class="n">getFeatures</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">geom</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span>
<span class="n">length</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">length</span><span class="p">()</span> <span class="c1"># En unités de la carte (ici en m.)</span>

<span class="c1"># Combien de points ?</span>
<span class="n">nb_pts</span> <span class="o">=</span> <span class="mi">50</span>

<span class="c1"># Distance entre points successifs</span>
<span class="n">step</span> <span class="o">=</span> <span class="n">length</span> <span class="o">/</span> <span class="n">nb_pts</span>

<span class="c1"># Création d&#39;un itérateur approprié et ajout des points créés à une liste :</span>
<span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">)):</span>
    <span class="c1"># Le resultat va être de type `QgsGeometry`</span>
    <span class="n">interp</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
    <span class="c1"># Convertit la géométrie en `QgsPointXY` et l&#39;ajoute au résultat</span>
    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interp</span><span class="o">.</span><span class="n">asPoint</span><span class="p">())</span>
</pre></div>
</div>
</li>
<li><p class="first">Récupérer la valeur de la (ou des) bande(s) raster à une coordonnée donnée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dem_pr</span> <span class="o">=</span> <span class="n">dem</span><span class="o">.</span><span class="n">dataProvider</span><span class="p">()</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">QgsPointXY</span><span class="p">(</span><span class="mi">925189</span><span class="p">,</span> <span class="mi">6473673</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">dem_pr</span><span class="o">.</span><span class="n">identify</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
    <span class="n">_values</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">results</span><span class="p">()</span> <span class="c1"># Retourne un dictionnaire</span>
    <span class="c1"># Affiche la valeur pour la première bande</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">_values</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Mieux formatté... :</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Le point (</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">) est situé à environ </span><span class="si">{:.2f}</span><span class="s2">m d&#39;altitude&quot;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
</li>
<li><p class="first"><strong>«&nbsp;Putting it all together&nbsp;»</strong></p>
<p>1. Vous disposez des briques essentielles pour créer un objet python de type <code class="docutils literal notranslate"><span class="pre">list</span></code>,
contenant, pour une cinquantaine de points répartis à égale distance le long du cours d’eau,
<strong>la distance à la source</strong> et <strong>l’altitude</strong> de chacun d’entre eux, par exemple sous la forme
d’un <code class="docutils literal notranslate"><span class="pre">tuple</span></code> de 2 éléments <em>(les coordonnées précises de chaque
point ne nous intéressent ici que pour connaitre son altitude)</em>. Ces deux informations,
distance à la source et altitude, seront par la suite utilisées, respectivement en abcisses
et en ordonnées, pour tracer le profil du cours d’eau.</p>
<p>2. Lisez le tutoriel <a class="reference external" href="https://futurestud.io/tutorials/matplotlib-simple-line-plots">https://futurestud.io/tutorials/matplotlib-simple-line-plots</a>
et essayez de mobiliser ces nouvelles notions pour utiliser la liste obtenue à l’étape (1)
afin d’obtenir le résultat suivant :</p>
<div class="figure align-center" style="width: 98%">
<a class="reference internal image-reference" href="_images/ex5_matplotlib.png"><img alt="_images/ex5_matplotlib.png" src="_images/ex5_matplotlib.png" style="width: 40%;" /></a>
</div>
</li>
<li><p class="first"><strong>Déjà fini ? Utilisez maintenant ces points pour créer une couche de point 3D</strong>
Dans cet exercice et contrairement à l’exemple précédent, les coordonnées de chaque nouveau point
nous intéressent : elles vont être enrichie de l’altitude du point.
Ces points devront être ajoutés à <strong>une nouvelle couche en mémoire</strong> qui aura
précédemment été créée avec <strong>deux champs attributaires</strong>,
l’un pour l’identifiant du point (de type <em>entier</em>) et l’autre pour
la distance à la source (de type <em>double flottant</em>).</p>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>L’API exposée par PyQgis n’est pas toujours très «&nbsp;pythonique&nbsp;».
Certaines fonctions relative à la manipulation des données raster ou vecteur ne vont pas générer une <code class="docutils literal notranslate"><span class="pre">Exception</span></code>
comme c’est la convention en Python mais vont retourner une valeur booléenne qu’il
faudra lire pour s’assurer de la bonne exécution de la fonction en question (pensez aux exercices précédent lorsque
vous avez pu voir <code class="docutils literal notranslate"><span class="pre">True</span></code> - ou <code class="docutils literal notranslate"><span class="pre">False</span></code> - affiché dans l’interpréteur lors de certaines opérations
telles que l’appel de la méthode <code class="docutils literal notranslate"><span class="pre">updateFeature</span></code>).</p>
<div class="last highlight-python notranslate"><div class="highlight"><pre><span></span> <span class="k">for</span> <span class="n">ix</span><span class="p">,</span> <span class="n">dist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">step</span><span class="p">))):</span>
     <span class="n">pt</span> <span class="o">=</span> <span class="n">geom</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span><span class="o">.</span><span class="n">asPoint</span><span class="p">()</span>
<span class="hll">     <span class="n">alt</span><span class="p">,</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">data_pr</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="hll">     <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
</span>         <span class="n">new_pt</span> <span class="o">=</span> <span class="n">QgsPoint</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">(),</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">(),</span> <span class="n">alt</span><span class="p">)</span>
         <span class="n">feat</span> <span class="o">=</span> <span class="n">QgsFeature</span><span class="p">()</span>
         <span class="n">feat</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="n">QgsGeometry</span><span class="p">(</span><span class="n">new_pt</span><span class="p">))</span>
         <span class="n">feat</span><span class="o">.</span><span class="n">setAttributes</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span> <span class="n">dist</span><span class="p">])</span>
         <span class="n">ok</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">addFeature</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
<span class="hll">         <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
</span><span class="hll">             <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Erreur lors de la création de l&#39;entité {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="p">))</span>
</span>     <span class="k">else</span><span class="p">:</span>
         <span class="k">print</span><span class="p">(</span>
           <span class="s2">&quot;Erreur lors de la récupération de l&#39;altitude pour l&#39;entité {}&quot;</span>
           <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="s2">&quot;)</span>
</pre></div>
</div>
</div>
<hr width="100%" size="18">
<p class="align-center"><strong>💡 <a href="solutions/s_ex4.html">Solution de l'exercice 4</a></strong></p><p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="f1" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Institut national de l’information géographique et forestière : <a class="reference external" href="http://professionnels.ign.fr/bdtopo">http://professionnels.ign.fr/bdtopo</a>. Données téléchargées le 28/02/2019.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="f2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>European Environment Agency : <a class="reference external" href="https://www.eea.europa.eu/data-and-maps/data/copernicus-land-monitoring-service-eu-dem">https://www.eea.europa.eu/data-and-maps/data/copernicus-land-monitoring-service-eu-dem</a>. Données téléchargées le 28/02/2019.</td></tr>
</tbody>
</table>
</div>
</div>


          </div>
            
  <div class="footer-relations">
    
      <div class="pull-left">
        <a class="btn btn-default" href="ex3.html" title="Chapitre précédent (use the left arrow)">Exercice 3 : Géométries et calcul de champ</a>
      </div>
    
      <div class="pull-right">
        <a class="btn btn-default" href="ex5.html" title="Chapitre suivant (use the right arrow)">Exercice 5 : Manipulation de couches vecteurs et géotraitements</a>
      </div>
    </div>
    <div class="clearer"></div>
  
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="Index général"
             >index</a></li>
        <li class="right" >
          <a href="ex5.html" title="Exercice 5 : Manipulation de couches vecteurs et géotraitements"
             >suivant</a> |</li>
        <li class="right" >
          <a href="ex3.html" title="Exercice 3 : Géométries et calcul de champ"
             >précédent</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Documentation PythonQGIS_TP 2022.03</a> &#187;</li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2018-2022, Matthieu Viry. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>
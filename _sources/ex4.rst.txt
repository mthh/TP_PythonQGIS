Exercice 4 : Automatisation d'actions r√©p√©titives
=================================================

.. figure:: img/ex4_osm.png
  :width: 40%
  :align: center
  :figwidth: 98%


Objectif
--------

Cet exerice a pour objectif de montrer l'int√©r√™t de la console Python pour automatiser des actions r√©p√©titives.

Donn√©es
-------

| ‚Ä¢ ``malta-latest.shp.zip`` : Donn√©es **OpenStreetMap** (transform√©es en Shapefile par GeoFabrik) pour Malte [#f1]_  ‚ûú `T√©l√©chargement <http://download.geofabrik.de/europe/malta-latest-free.shp.zip>`_
| ‚Ä¢ ``StylesQgisOsm.zip`` : Une collection de styles QGIS pour donn√©es OSM [#f2]_ ‚ûú `T√©l√©chargement <https://mthh.github.io/TP_PythonQGIS/_static/StylesQgisOsm.zip>`_


Probl√®me
--------

Lors de la d√©compression de l'archive ``malta-latest.shp.zip`` on peut constater
que de nombreux fichiers sont extraits (16 couches). Seules 11 d'entres elles vont
nous √™tre utile.

Pour appliquer les styles t√©l√©charg√©s, en l'absence de projet ``.qgs`` nous devrons effectuer les √©tapes suivantes.
  - charger les diff√©rentes couches n√©cessaires,
  - appliquer le style t√©l√©charg√© (par exemple : double-click sur la couche ``gis_osm_water_a_free_1.shp``
    pour ouvrir les propri√©t√©s de style, puis click sur ``Style .. > Charger style ..`` et s√©lection du style
    ayant le nom ``gis_osm_water_a_free_1.qml``),
  - ... en faisant attention √† l'ordre des couches !
  - ... et en r√©p√©tant l'op√©ration pour chacune des couches !

.. figure:: img/ex4_consignes_GH.png
  :align: center
  :figwidth: 98%
  :class: m12

  *Exemple d'instructions trouv√©es sur internet (1)*


.. figure:: img/ex4_consignes_GH2.png
  :align: center
  :figwidth: 98%
  :class: m12, w100

  *Exemple d'instructions trouv√©es sur internet (2)*

N'√©tant pas satisfait par les propri√©t√©s de transparence, nous verrons
commment la changer sur toutes les couches qui contiennent des polygones.

On va tout effectuer en Python pour voir le gain de temps que √ßa peut repr√©senter.

Proc√©dure
---------

- **D√©compresser l'archive 'StylesQgisOsm.zip' dans un dossier de votre choix ('exercice4' par exemple)**. L'archive contenant les couches de donn√©es sera √† d√©compresser en Python.

- **Ouvrir QGIS**.

- **Ouvrir la console Python (les fichiers seront extraits de l'archive et ajout√©s √† la carte en Python)**.

- **Lire les rappels et les nouveaux √©l√©ments qui suivent :**.

  * Rappel concernant les dossiers en Python :
    ::

      # On acc√®de √† la majorit√© des fonctions relatives √† la navigation
      # dans l'arborescence du syst√®me de fichier √† part du module 'os'
      import os

      # Connaitre le dossier actuel de travail
      os.getcwd() # getcwd -> get current working directory

      # Se rendre dans le dossier appropri√© (attention √† le modifier)
      os.chdir('exercice4')

      # Lister le contenu d'un dossier (ici le dossier 'Styles')
      os.listdir('Styles') # On utilise '.' pour le dossier actuel


  * On peut ainsi effectuer des op√©rations de filtrage lors du listage du dossier
    ::

      # Lister les fichiers d'un type particulier au sein d'un dossier
      # en utilisant une liste de compr√©hension
      names_svg = \
          [name for name in os.listdir('/home/mthh/Images') if '.svg' in name]

  * Rappel sur les chaines de caract√®res
    ::

      # Remplacer/supprimer une sous-chaine de caract√®res :
      name = 'filename.svg'
      name.replace('.svg', '')  # 'filename'
      name.replace('.svg', '.png')  # 'filename.png'

  * Extraire une archive ``.zip`` dans le dossier courant depuis l'interpr√©teur Python :
    ::

      import zipfile

      zip_ref = zipfile.ZipFile('malta-latest-free.shp.zip', 'r')
      zip_ref.extractall('.')
      zip_ref.close()


  * Nouvelles notions en PyQgis concernant l'interface (``QgisInterface``) ou le projet (``QgsProject``) en cours :

    ::

      # Obtenir une r√©f√©rence au projet en cours :
      project = QgsProject.instance()

      # Enlever les couches existantes dans le projet actuel :
      project.clear()

      # Zoomer la carte sur une couche (ici sur la couche active) :
      layer = iface.activeLayer()
      canvas = iface.mapCanvas()
      canvas.setExtent(layer.extent())
      canvas.refresh()

      # Changer l'√©tendue du canvas en utilisant
      # des coordonn√©es xmin, ymin, xmax, ymax :
      rect = QgsRectangle(QgsRectangle(1599940, 4284653, 1617650, 4284653))
      iface.mapCanvas().setExtent(rect)
      iface.mapCanvas().refresh()

      # R√©gler la projection du projet sur "Web-Mercator" :
      project.setCrs(QgsCoordinateReferenceSystem('EPSG:3857'))
      iface.mapCanvas().refresh()


  * Nouvelles notions en PyQgis concernant les couches vecteurs (``QgsVectorLayer``)

    ::

      # Ajouter une couche :
      layer = iface.addVectorLayer('path/to/layer.shp', name, 'ogr')

      # Charger un style et le lui appliquer :
      layer.loadNamedStyle('path/to/style.qml')
      layer.triggerRepaint()

      # Si on ajoute plusieurs couches √† la suite et que la mise en cache
      # n'est pas active on √©vitera d'appeler la m√©thode 'triggerRepaint'
      # sur chaque couche et on pr√©f√©rera rafraichir
      # l'ensemble du canvas une fois l'op√©ration termin√©e :
      if iface.mapCanvas().isCachingEnabled():
          layer.triggerRepaint()
      else:
          iface.mapCanvas().refresh()


- **√Ä vous de jouer !**
  En utilisant les √©l√©ments vu au-dessus, √©crivez un script permettant de :

    * se rendre dans le dossier dans lequel vous avez d√©compresser la premi√®re archive,
    * y d√©zipper la seconde (``malta-latest.shp.zip``) dans le m√™me dossier,
    * lister les styles disponibles (fichiers ``.qml`` dans le dossier ``Styles``),
    * utiliser leurs noms pour charger les fichiers *Shapefile* correspondants,
    * appliquer le style appropri√© √† chacune des couches.


- Et l'ordre des couches ? Voici l'ordre optimal pour ce projet *(la premi√®re couche de la liste est celle qui doit appara√Ætre
  au-dessus de toutes les autres √† l'affichage, c'est le m√™me ordre que dans le panneau de gestion des couches de QGIS)*.
  Utiliser cette variable pour obtenir l'ordre souhait√© dans votre projet !

  **√Ä vous de jouer !** *(La cheatsheet de ce TP, un moteur de recherche et/ou la documentation PyQgis
  seront utiles)*

  ::

    ordre = [
        'gis_osm_traffic_a_free_1',
        'gis_osm_pofw_a_free_1',
        'gis_osm_places_free_1',
        'gis_osm_natural_free_1',
        'gis_osm_roads_free_1',
        'gis_osm_buildings_a_free_1',
        'gis_osm_pois_a_free_1',
        'gis_osm_water_a_free_1',
        'gis_osm_waterways_free_1',
        'gis_osm_landuse_a_free_1',
        'gis_osm_natural_a_free_1',
        ]


- Nous devons maintenant r√©gler l'opacit√© de chacune des couches de
  type ``Polygon`` √† 90%.

  **√Ä vous de jouer !** *(La cheatsheet de ce TP, un moteur de recherche et/ou la documentation PyQgis
  seront utiles)*


Sauvegarder votre projet
------------------------

- Il est n√©cessaire de r√©cup√©rer une r√©f√©rence au projet actuel :
  ::

    project = QgsProject.instance()
    # Attention au chemin du fichier que vous sauvegardez !
    project.write('osm_malta.qgs')


Autres exemples d'utilisation du Python dans QGIS
-------------------------------------------------

Qu'en est-il des actions qu'il pourrait √™tre n√©cessaire d'effectuer √† chaque ouverture d'un projet
sp√©cifique ? Il est possible de d√©finir des fonctions Python qui seront appel√©es √† l'ouverture, √† l'enregistrement ou
√† la fermeture d'un projet.

.. figure:: img/ex4_macros.png
  :width: 100%
  :align: center
  :figwidth: 98%


- Nous souhaitons par exemple afficher un message d'avertissement √† l'ouverture d'un projet :
  ::

    def openProject():
        msg_bar = iface.messageBar()
        msg_bar.pushMessage(
          'WARNING', # Le titre du message
          'Le projet contient des donn√©es sensibles.', # Son contenu
          Qgis.WARNING, # Le type de message
          15, # Le d√©lai d'affichage
        )

.. raw:: html

   <hr width="100%" size="18">
   <p class="align-center"><strong>üí° <a href="solutions/s_ex3.html">Solution de l'exercice 3</a></strong></p>

.. rubric:: Footnotes

.. [#f1] `¬© les contributeurs d‚ÄôOpenStreetMap <https://www.openstreetmap.org/copyright>`_. Source : http://download.geofabrik.de/europe/malta.html. Donn√©es t√©l√©charg√©es le 01/03/2020.
.. [#f2] Adapt√©s depuis les styles de `MrXsquared <https://github.com/MrXsquared/>`_. Donn√©es t√©l√©charg√©es le 01/03/2020.

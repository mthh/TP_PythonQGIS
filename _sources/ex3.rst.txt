Exercice 3 : G√©om√©tries et calcul de champ
==========================================


.. figure:: img/ex3_intro.png
  :width: 30%
  :align: center
  :figwidth: 98%

Objectif
--------

L'objectif de cet exercice est double : manipuler les g√©om√©tries relatives √† chaque
entit√©s et √©diter une couche pour l'enrichir.

√Ä partir de la couche vectorielle contenant les pays du monde, nous cherchons
√† trouver tous les polygones limitrophes √† chaque polygone *(tous les voisins de chaque pays)*.

La couche d'entr√©e va √™tre enrichie de deux nouveaux champs, l'un contenant
le noms des voisins et l'autre contenant la population totale de ces voisins.


Donn√©es
-------

Les donn√©es proviennent de Natural Earth [#f1]_ :

| ‚Ä¢ ``ne_10m_admin_0_countries.shp`` (Polygones - Pays du monde) ‚ûú `T√©l√©chargement <https://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_0_countries.zip>`_


Proc√©dure
---------

La m√©thode √† utiliser peut √™tre d√©crite de la mani√®re suivante :

    Pour chaque pays **P**:

      - trouver les polygones qui intersectent sa bounding box
      - parmis ces polygones :

        * trouver ceux qui sont r√©element voisins du pays **P**
      - enregistrer le nom des voisins de **P** dans le champ ``NEIGHBORS``
      - enregistrer la somme de la population de ces voisins dans le champ ``SUM``

Cet exerice mobilise plusieurs notions nouvelles :

    - √©dition d'une couche

    ::

      # Au d√©but de l'√©dition :
      layer.startEditing()

      # √Ä la fin de l'√©dition pour valider :
      layer.commitChanges()

      # Pour abandonner les changements en cours :
      layer.rollBack()

    - cr√©ation de nouveaux champs attributaires

    ::

      from PyQt5.QtCore import QVariant

      # La couche `layer` doit √™tre en cours d'√©dition !
      # Cr√©ation d'un champ de chacun des 3 principaux types
      # qui seront utilis√©s :
      layer.dataProvider().addAttributes(
          [QgsField("Champ_1", QVariant.String),
           QgsField("Champ_2", QVariant.Int),
           QgsField("Champ_3", QVariant.Double)])
      layer.updateFields()

    - mise √† jour d'une entit√© apr√®s l'avoir modifi√©e

    ::

      # La couche `layer` doit √™tre en cours d'√©dition !
      # `ft` est une variable de type QgsFeature
      layer.updateFeature(ft)


    - utilisation de pr√©dicats spatiaux (intersects, disjoint, etc.)

    ::

      # Obtenir la g√©om√©trie d'une entit√© :
      geom1 = feature1.geometry()
      geom2 = feature2.geometry()

      # Pr√©dicats spatiaux :
      geom1.intersects(geom2) # -> True/False
      geom1.disjoint(geom2) # -> True/False
      geom1.touches(geom2) # -> True/False

    - utilisation d'un `index spatial`_

    ::

      # Cr√©ation de l'index :
      index = QgsSpatialIndex()
      for f in layer.getFeatures():
          index.insertFeature(f)

      # Interrogation de l'index
      # (l'argument de la m√©thode intersects de l'index
      #  spatial doit √™tre de type `QgsRectangle`)
      intersecting_ids = index.intersects(geom.boundingBox())

      # Une des fa√ßon d'obtenir les entit√©s qui correspondent √† ces ids :
      request = QgsFeatureRequest().setFilterFids(intersecting_ids)
      for feature in vector_layer.getFeatures(request):
          # ...


**√Ä vous de jouer ! Essayer d'√©crire le script permettant d'atteindre l'objectif de cet exercice**

La m√©thode √† utiliser peut √™tre d√©crite de la mani√®re suivante :

  Cr√©ation de deux champs ``NEIGHBORS`` et ``SUM`` (attention au type !)

  Cr√©ation de l'index spatial

  Parcours des entit√©s de la couche, pour chaque pays **P**:

    - trouver les polygones qui intersectent sa bounding box (grace √† l'index spatial)
    - parmis ces polygones :

      * trouver ceux qui sont r√©element voisins du pays **P**
      * enregistrer le nom des voisins de **P** dans le champ ``NEIGHBORS``
      * enregistrer la somme de la population de ces voisins dans le champ ``SUM``
      * mettre √† jour l'entit√© en question

  Validation des changements effectu√©s sur la couche.


**‚ûú Quelle est la population des pays voisins de la Hongrie ?**

**‚ûú Combien de pays n'ont aucun voisin ?**


.. raw:: html

   <hr width="100%" size="18">
   <p class="align-center"><strong>üí° <a href="solutions/s_ex3.html">Solution de l'exercice 3</a></strong></p>
   <hr width="100%" size="18">


.. rubric:: Footnotes

.. [#f1] http://www.naturalearthdata.com/. Consult√© le 28/02/2023.

.. _`index spatial`: https://fr.wikipedia.org/wiki/Index_spatial

Exercice 6 : Manipulation de couches vecteurs et g√©otraitements
===============================================================

.. figure:: img/ex6_intro.png
  :width: 40%
  :align: center
  :figwidth: 98%


.. rubric:: \
|

  **‚ö†** *Vous devrez envoyer le script permettant de r√©pondre aux questions 4-5-6-7-8 √† la fin du TP* **‚ö†**


Objectif
--------

L'objectif de cet exercice est de continuer √† se familiariser avec :

- la manipulation des couches dans l'interface de QGIS
- la r√©alisation de g√©otraitements


Donn√©es
-------

| ‚Ä¢ La couche des communes de France M√©tropolitaine (Polygone - Source : ADMIN EXPRESS COG 2.0 2019, IGN [#f1]_) ‚ûú `T√©l√©chargement <ftp://Admin_Express_ext:Dahnoh0eigheeFok@ftp3.ign.fr/ADMIN-EXPRESS-COG_2-0__SHP__FRA_L93_2019-09-24.7z.001>`_
| ‚Ä¢ Trac√© du Canal du Furon ``Canal_Furon.shp`` (Ligne - Source : BD TOPO 2.0, IGN [#f2]_) ‚ûú `T√©l√©chargement <https://mthh.github.io/TP_PythonQGIS/_static/CanalFuron.zip>`_


Proc√©dure
---------

- Ouvrir QGIS.

- Ouvrir la console Python.

.. - Lors de l'exercice 4, les couches ont √©t√© ajout√©es en Python depuis le dossier qui les contenait.
..   Si le projet n'a pas √©t√© sauvegard√© dans le m√™me dossier, il est possible de modifier le chemin d'acc√®s
..   √† chacune des couches en Python et, par exemple, sans utiliser QGIS.
..
..   En effet, les projets QGIS sont stock√©s au format XML et la biblioth√®que standard Python propose plusieurs
..   solutions pour lire et modifier ce format de fichiers. Nous allons, en quelques lignes, changer le chemins de chacune des
..   couches d'un projet QGIS.
..
..   ::
..
..     import xml.etree.ElementTree as ET
..     import os
..
..     # Le chemin correspondant aux couches shapefile
..     # depuis le projet .qgs a modifier
..     # (correspondant ici a 'data/ex4')
..     prefix = os.path.join('data', 'ex4')
..
..     # Ouverture du projet
..     tree = ET.parse('projet_exo4.qgs')
..     root = tree.getroot()
..
..     # Pour chaque groupe de couches dans notre projet :
..     for layer_group in root.findall('layer-tree-group'):
..         # Pour chaque couche (chaque noeud 'layer-tree-layer')
..         # le chemin est dans l'attribut source
..         for layer in layer_group.findall('layer-tree-layer'):
..             # Recuperation du nom du fichier
..             src = layer.get('source')
..             # Join le nom du dossier et le nom du chemin
..             new_src = os.path.join(prefix, src)
..             # Remplace le chemin par la chemin avec prefix
..             layer.set('source', new_src)
..
..
..     # Ecriture du resultat
..     tree.write('projet_exo4.qgs')
..
..
..   On peut maintenant essayer d'ouvrir √† nouveau le projet dans l'interface.
..
.. - Ouvrir un nouveau projet, en cliquant sur l'icone dans l'interface ou en Python :
..   ::
..
..     QgsProject.instance().clear()
..

- Ajouter la couche ``Canal_Furon.shp`` et la couche ``COMMUNES.shp`` et obtenir l'objet Python
  correspondant √† chacune des couches.
  ::

    furon = QgsProject.instance().mapLayersByName("Canal_Furon")[0]
    communes = QgsProject.instance().mapLayersByName("COMMUNE")[0]


- La couche ``Canal_Furon.shp`` ne contient qu'une entit√©, on acc√®de directement √† sa g√©om√©trie de la fa√ßon suivante :
  ::

    ft_furon = list(furon.getFeatures())[0]
    geom_furon = ft_furon.geometry()


- **Q1. Quel est le type de l'objet** ``geom_furon`` **?**

  .. container:: spoiler blq

     Solution
     ::

       print(type(geom_furon))
       # Il s'agit d'un objet de type `QgsGeometry`.


- **Q2**.√âtant-donn√© les deux couches d'informations dont on dispose, **quel pr√©dicat
  spatial peut-on utiliser** pour r√©pondre √† la question suivante : **Quelle sont les communes travers√©es par le Canal du Furon ?**

  .. container:: spoiler blq

     Solution
     ::

       # On peut utiliser le pr√©dicat spatial `intersects`.


- **Q3. Comment ce probl√®me pourrait-il √™tre formul√© d'un point de vue algorithmique ?**

  .. container:: spoiler blq

     Solution

       Soit **L** une liste vide

       Pour chaque entit√© **FT** de la couche *communes* :

        - Si la *geometrie* de **FT** intersecte la *g√©ometrie* du **cours d'eau** :

          - Ajout du nom de **FT** √† la liste **L**.


- **Q4. Cr√©er une liste qui contient le nom des communes travers√©es par le canal du Furon.**


- Les objets ``QgsGeometry`` disposent d'une m√©thode buffer qui retourne une nouvelle ``QgsGeometry``.
  On peut cr√©er une zone tampon de 250m autour du cours d'eau de la mani√®re suivante :
  ::

    geom_buffer = geom_furon.buffer(250., 8)


- **Q5. Quelle type de g√©om√©trie est obtenu en r√©sultat ? √âcrivez l'instruction qui permet d'afficher cette information.**



- **Q6. Cr√©er une nouvelle liste contenant le nom des communes qui croisent cette zone tampon. Combien sont-elles ?**


- Bien que nous aillons pu manipuler la zone tampon pr√©c√©demment cr√©√©e, elle n'a pas encore √©t√© ajout√©e √† la carte.
  En effet cette g√©om√©trie n'appartient pour l'instant √† aucune entit√© ni √† aucune couche.

  **Q7. Quelles √©tapes peuvent-√™tre mises en oeuvres pour afficher cette zone sur la carte ? √âcrivez le code n√©cessaire cr√©er une nouvelle couche contenant cette zone tampon et pour l'ajouter sur la carte.**

- **Q8. En utilisant les √©l√©ments vus pr√©c√©demment, la documentation PyQgis ainsi que les ressources pr√©sentes sur le Web :**

  * **1) Cr√©er une nouvelle s√©lection sur la couche des communes : celles qui intersectent la couche de la zone tampon cr√©√©e dans la question pr√©c√©dente** *(les entit√©s s√©lectionn√©es doivent s'afficher en jaune sur la carte)*
  * **2) Sauvegarder uniquement les entit√©s s√©lectionn√©s dans une nouvelle couche au format Shapefile.**

.. raw:: html

   <hr width="100%" size="18">

- **D√©j√† termin√© !?** Prenez connaissance de la documentation de PyQgis sur la communication avec l'utilisateur : `Communicating with the user <https://docs.qgis.org/3.4/en/docs/pyqgis_developer_cookbook/communicating.html>`_. Testez et modifiez les diff√©rents exemples qui sont propos√©s de fa√ßon √† bien les comprendre : ces aspects seront utiles si vous souhaitez d√©velopper un plugin pour QGIS en Python.


.. raw:: html

   <hr width="100%" size="18">
   <p class="align-center"><strong>üí° <a href="solutions/s_ex6.html">Solution de l'exercice 6</a></strong></p>


.. rubric:: Footnotes

.. [#f1] Institut national de l'information g√©ographique et foresti√®re : https://geoservices.ign.fr/documentation/diffusion/telechargement-donnees-libres.html#admin-express. Donn√©es t√©l√©charg√©es le 10/03/2020.
.. [#f2] Institut national de l'information g√©ographique et foresti√®re : http://professionnels.ign.fr/bdtopo. Donn√©es t√©l√©charg√©es le 28/02/2019.
